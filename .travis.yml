services: docker
language: go

branches:
  only:
    - master
    - /^v\d+\.\d+\.\d+.*$/

env:
  - ARCH=amd64
  - ARCH=armhf
  - ARCH=arm64

install:
  - go get -v github.com/estesp/manifest-tool
  - docker run --rm --privileged multiarch/qemu-user-static:register --reset

script:
  - make test ARCH=${ARCH} BUILD_VERSION=1.9.0-${TRAVIS_BUILD_NUMBER}

after_success:
  - echo ${DOCKER_PASSWORD} | docker login -u "${DOCKER_USERNAME}" --password-stdin
  - make push ARCH=${ARCH}
  - make manifest || true
